export const meta = {
  title: `Manage user session and credentials`,
  description: `Learn how to manage user sessions and credentials.`,
};

<InlineFilter filters={["js"]}>

[comment]: # (source content from lib/auth/manageusers/q/platform/js/#retrieve-current-session ; src/fragments/lib/auth/js/manageusers.mdx)

Amplify Auth provides access to current user sessions and tokens to help you retrieve your customer's information to determine if they are logged in with a valid session and control their access to your app. You can manage tokens and expiration times and revoke sessions. In this guide we will review how to retrieve your user’s session and understand what token management options are available.

Before you begin you will need:
- Sign-up set up
- A test user signed in

## Retrieve my current authenticated user

You can use the `Auth.currentAuthenticatedUser()` API which returns the full `CognitoUser` object. This object contains information about the currently authenticated user including the session and user attributes.

To call `Auth.currentAuthenticatedUser()` to get the current authenticated user object:

<BlockSwitcher>
<Block name="TypeScript">

```ts
import { Auth } from 'aws-amplify';

async function currentAuthenticatedUser() {
  try {
    const user = await Auth.currentAuthenticatedUser({
      bypassCache: false // Optional, By default is false. If set to true, this call 
      // will send a request to Cognito to get the latest user data.
    });
    console.log(user);
  } catch(err) {
    console.log(err);
  }
};
```
</Block>
<Block name="JavaScript">

```javascript
import { Auth } from 'aws-amplify';

async function currentAuthenticatedUser() {
  try {
    const user = await Auth.currentAuthenticatedUser({
      bypassCache: false // Optional, By default is false. If set to true, this call
      // will send a request to Cognito to get the latest user data.
    });
    console.log(user);
  } catch(err) {
    console.log(err);
  }
};
```
</Block>
</BlockSwitcher>

This method can be used to check if a user is signed as it will throw an error if there is no current user signed in. Be sure to call this method after the `Auth` module is configured. 

## Retrieve my user’s session

If you only need the session details you can use `Auth.currentSession()` which returns a `CognitoUserSession` object which contains the JWT (JSON Web Token). Credentials are exchanged for temporary access tokens when your users sign in. You can access these tokens to get user information to validate user access or perform actions unique to that user. 

<Accordion title='Review what the session object contains and how tokens work' headingLevel='4' eyebrow='Learn more'>

This secure information in the `CognitoUserSession` object includes:
- `idToken` - A JWT that contains user identity information like username and email. It is used to authenticate the user.
- `accessToken` - A JWT used to access protected AWS resources and APIs. It contains the authorized scope.
- `refreshToken` - This a longer-lived token used to refresh expired access tokens by generating new ID and access tokens.
- `clockDrift` - Identifies the Clock Drift.

Amazon Cognito tokens work by generating temporary access and ID tokens with an expiration time at user sign-in. The tokens are validated against the user pool to authorize access until they expire.

</Accordion>

<br/>

<Callout>

**Note:** This method will automatically refresh the `accessToken` and `idToken` if tokens are expired and a valid `refreshToken` presented. So you can use this method to refresh the session if needed.

</Callout>

<BlockSwitcher>
<Block name="TypeScript">

```ts
import { Auth } from 'aws-amplify';

async function currentSession() {
  try {
    const { accessToken, idToken, refreshToken } = await Auth.currentSession();
  } catch(err) {
    console.log(err);
  }
};

```

</Block>
<Block name="JavaScript">

```javascript
import { Auth } from 'aws-amplify';

async function currentSession() {
  try {
    const { accessToken, idToken, refreshToken } = await Auth.currentSession();
  } catch(err) {
    console.log(err);
  }
};
```

</Block>
</BlockSwitcher>

## Understand token management options

Token keys are automatically rotated for you for added security but you can update how they are stored, customize the refresh rate and expiration times, and revoke tokens on sign out.

### Update your token-saving mechanism


You can update the storage mechanism to choose where and how tokens are persisted in your application. The default `localStorage` is suitable for most use cases, but you may want to use a different option for security or user experience reasons.

#### Browser Local Storage

In Amplify the `localStorage` is the default storage mechanism. It saves the tokens in the browser's `localStorage`. This local storage will persist across browser sessions and tabs. You can implicitly set to this storage by calling:

```javascript
Auth.configure({
  storage: localStorage
});
```

#### Browser Session Storage

`sessionStorage` saves the tokens in the browser's `sessionStorage` and these tokens will clear when a tab is closed. The benefit to this storage mechanism is that the session only lasts as long as the browser is open and you can sign out users when they close the tab. You can update to this storage by calling:

```javascript
Auth.configure({
  storage: sessionStorage
}); 
```

#### Custom Storage

You can implement your own custom storage mechanism by creating a class that implements the storage interface. Here is an example of using custom storage that uses memory storage:

```javascript
export class MyCustomStorage {

    storageObject = {};
  
    setItem(key, value) {
        this.storageObject[key] = value
    }
    getItem(key) {
        return this.storageObject[key]
    }
    removeItem(key) {
        delete this.storageObject[key]
    }
  
    clear() {
        storageObject = {};
        return storageObject;
    }
}

Auth.configure({
  storage: new MyCustomStorage()
});
```

When you get the current user session, the tokens will be saved in your custom location.

<Callout>

**Note:** You can also update token expiration times depending on how you configured your Amazon Cognito User Pool. If you used the Amplify CLI, you can run `amplify update auth` to do so. If not, you can also go through the Amazon Cognito User Pool console under "App integration" > "App client" settings or update the appropriate parameters via the AWS CLI or CDK.

</Callout>

### Revoke tokens

Token revocation is enabled by default in new Cognito User Pool Clients, however you you are using an existing client, you may need to enable it. This allows for all access tokens that were previously issued by that refresh token to become invalid. However, other refresh tokens issued to the user are not affected.

To revoke tokens you can set up global sign-out with `Auth.signOut({ global: true })` to globally sign out your user, which will invalidate them immediately. Additionally, you can also invoke the [`RevokeToken`](https://docs.aws.amazon.com/cognito-user-identity-pools/latest/APIReference/API_RevokeToken.html) API or [Revoke endpoint](https://docs.aws.amazon.com/cognito/latest/developerguide/revocation-endpoint.html) directly.

You can now change the user experience for your app by updating how and where your tokens are saved and managed.

## Conclusion

Congratulations! You finished the **Manage user session and credentials** guide. In this guide, you learned how to retrieve you current authenticated user, the user's session details, and reviewed several ways you can manage these user credentials.

## Next steps

Now that you updated how your credentials are managed you may also want to further refine the sing-in and sign-out workflows as well as update how you listen for these Auth events. We recommend you learn more about:

- [Enable sign-up, sign-in, and sign-out](/lib/auth/emailpassword/q/platform/js/)
- [Auth events](/lib/auth/auth-events/q/platform/js/)

</InlineFilter>
